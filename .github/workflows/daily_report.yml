# Daily Investment Report Workflow
# Runs daily to calculate and send investment reports via Telegram

name: daily-report

on:
  # Run on push to main branch
  push:
    branches: [main]
  
  # Schedule: Mon-Fri at 15:00 UTC (23:00 Beijing Time)
  schedule:
    - cron: '0 15 * * 1-5'
  
  # Allow manual trigger
  workflow_dispatch:

env:
  TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}

jobs:
  report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Download data from Gist
        run: |
          mkdir -p data
          curl -sH "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -o data/stock.yaml \
            "https://gist.githubusercontent.com/${{ github.repository_owner }}/${{ secrets.GIST_ID_STOCK }}/raw/stock.yaml"
          curl -sH "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -o data/fund.yaml \
            "https://gist.githubusercontent.com/${{ github.repository_owner }}/${{ secrets.GIST_ID_FUND }}/raw/fund.yaml"
          curl -sH "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -o data/grace_fund.yaml \
            "https://gist.githubusercontent.com/${{ github.repository_owner }}/${{ secrets.GIST_ID_GRACE_FUND }}/raw/grace_fund.yaml"
          curl -sH "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -o data/personal_fund.yaml \
            "https://gist.githubusercontent.com/${{ github.repository_owner }}/${{ secrets.GIST_ID_PERSONAL_FUND }}/raw/personal_fund.yaml"

      - name: Generate stock report
        id: stock_report
        run: |
          echo 'report<<EOF' >> $GITHUB_OUTPUT
          uv run python << 'SCRIPT' >> $GITHUB_OUTPUT
          import json
          import subprocess
          from datetime import datetime

          year = str(datetime.now().year)
          result = subprocess.run(
              ['uv', 'run', 'python', '-m', 'invest_ai.cli.main', '--type', 'stock', '--year', year, '--format', 'json'],
              capture_output=True, text=True
          )
          
          try:
              # Find JSON in output (may have warnings before it)
              stdout = result.stdout.strip()
              json_start = stdout.find('{')
              if json_start >= 0:
                  data = json.loads(stdout[json_start:])
              else:
                  raise ValueError("No JSON found in output")
              gain_emoji = 'ðŸ“ˆ' if data['net_gain'] >= 0 else 'ðŸ“‰'
              print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
              print(f'{gain_emoji} Stock {year}')
              print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
              print(f"ðŸ’µ Start: Â¥{data['start_value']:>12,.0f}")
              print(f"ðŸ’° End:   Â¥{data['end_value']:>12,.0f}")
              print(f"ðŸŽ Div:   Â¥{data['dividends']:>12,.0f}")
              print(f"{gain_emoji} Gain:  Â¥{data['net_gain']:>12,.0f}")
              print(f"ðŸ“Š Rate:  {data['return_rate']:>12.1f}%")
          except Exception as e:
              print('ðŸ“ˆ Stock report failed')
              print(f'Error: {e}')
              print(f'Stderr: {result.stderr[:500] if result.stderr else "None"}')
              print(f'Stdout: {result.stdout[:500] if result.stdout else "None"}')
          SCRIPT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Generate fund report
        id: fund_report
        run: |
          echo 'report<<EOF' >> $GITHUB_OUTPUT
          uv run python << 'SCRIPT' >> $GITHUB_OUTPUT
          import json
          import subprocess
          from datetime import datetime

          year = str(datetime.now().year)
          result = subprocess.run(
              ['uv', 'run', 'python', '-m', 'invest_ai.cli.main', '--type', 'fund', '--data', 'data/fund.yaml', '--year', year, '--format', 'json'],
              capture_output=True, text=True
          )
          
          try:
              # Find JSON in output (may have warnings before it)
              stdout = result.stdout.strip()
              json_start = stdout.find('{')
              if json_start >= 0:
                  data = json.loads(stdout[json_start:])
              else:
                  raise ValueError("No JSON found in output")
              gain_emoji = 'ðŸ“ˆ' if data['net_gain'] >= 0 else 'ðŸ“‰'
              print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
              print(f'{gain_emoji} Fund {year}')
              print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
              print(f"ðŸ’µ Start: Â¥{data['start_value']:>12,.0f}")
              print(f"ðŸ’° End:   Â¥{data['end_value']:>12,.0f}")
              print(f"ðŸŽ Div:   Â¥{data['dividends']:>12,.0f}")
              print(f"{gain_emoji} Gain:  Â¥{data['net_gain']:>12,.0f}")
              print(f"ðŸ“Š Rate:  {data['return_rate']:>12.1f}%")
          except Exception as e:
              print('ðŸ’° Fund report failed')
              print(f'Error: {e}')
          SCRIPT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Generate grace fund report
        id: grace_fund_report
        run: |
          echo 'report<<EOF' >> $GITHUB_OUTPUT
          uv run python << 'SCRIPT' >> $GITHUB_OUTPUT
          import json
          import subprocess
          from datetime import datetime

          year = str(datetime.now().year)
          result = subprocess.run(
              ['uv', 'run', 'python', '-m', 'invest_ai.cli.main', '--type', 'fund', '--data', 'data/grace_fund.yaml', '--year', year, '--format', 'json'],
              capture_output=True, text=True
          )
          
          try:
              # Find JSON in output (may have warnings before it)
              stdout = result.stdout.strip()
              json_start = stdout.find('{')
              if json_start >= 0:
                  data = json.loads(stdout[json_start:])
              else:
                  raise ValueError("No JSON found in output")
              gain_emoji = 'ðŸ“ˆ' if data['net_gain'] >= 0 else 'ðŸ“‰'
              print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
              print(f'ðŸŒ¸ Grace Fund {year}')
              print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
              print(f"ðŸ’µ Start: Â¥{data['start_value']:>12,.0f}")
              print(f"ðŸ’° End:   Â¥{data['end_value']:>12,.0f}")
              print(f"ðŸŽ Div:   Â¥{data['dividends']:>12,.0f}")
              print(f"{gain_emoji} Gain:  Â¥{data['net_gain']:>12,.0f}")
              print(f"ðŸ“Š Rate:  {data['return_rate']:>12.1f}%")
          except Exception as e:
              print('ðŸŒ¸ Grace fund report failed')
              print(f'Error: {e}')
          SCRIPT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Generate personal fund report
        id: personal_fund_report
        run: |
          echo 'report<<EOF' >> $GITHUB_OUTPUT
          uv run python << 'SCRIPT' >> $GITHUB_OUTPUT
          import json
          import subprocess
          from datetime import datetime

          year = str(datetime.now().year)
          result = subprocess.run(
              ['uv', 'run', 'python', '-m', 'invest_ai.cli.main', '--type', 'fund', '--data', 'data/personal_fund.yaml', '--year', year, '--format', 'json'],
              capture_output=True, text=True
          )
          
          try:
              # Find JSON in output (may have warnings before it)
              stdout = result.stdout.strip()
              json_start = stdout.find('{')
              if json_start >= 0:
                  data = json.loads(stdout[json_start:])
              else:
                  raise ValueError("No JSON found in output")
              gain_emoji = 'ðŸ“ˆ' if data['net_gain'] >= 0 else 'ðŸ“‰'
              print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
              print(f'ðŸ‘¤ Personal Fund {year}')
              print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
              print(f"ðŸ’µ Start: Â¥{data['start_value']:>12,.0f}")
              print(f"ðŸ’° End:   Â¥{data['end_value']:>12,.0f}")
              print(f"ðŸŽ Div:   Â¥{data['dividends']:>12,.0f}")
              print(f"{gain_emoji} Gain:  Â¥{data['net_gain']:>12,.0f}")
              print(f"ðŸ“Š Rate:  {data['return_rate']:>12.1f}%")
          except Exception as e:
              print('ðŸ‘¤ Personal fund report failed')
              print(f'Error: {e}')
          SCRIPT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Send stock report to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: ${{ steps.stock_report.outputs.report }}

      - name: Send fund report to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: ${{ steps.fund_report.outputs.report }}

      - name: Send grace fund report to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: ${{ steps.grace_fund_report.outputs.report }}

      - name: Send personal fund report to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: ${{ steps.personal_fund_report.outputs.report }}
